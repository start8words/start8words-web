<!DOCTYPE html>
<html lang="zh-HK">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WW024NHKJF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WW024NHKJF');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€¸æ™´å‘½ç† - å…è²»å…«å­—æ’ç›¤å·¥å…·</title>
    
    <script src="https://unpkg.com/lunar-javascript/lunar.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="style.css?v=3.0">
</head>
<body>

<div class="app-container">

    <div class="app-header">
        é€¸æ™´å‘½ç† - å…è²»å…«å­—æ’ç›¤å·¥å…·
    </div>

    <div id="auth-container" class="auth-box">
        <div id="loggedOutUI" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <span class="auth-hint">ä½¿ç”¨Googleå¸³æˆ¶ç™»å…¥å¾Œå¯ä»¥å„²å­˜å‘½ç›¤ã€‚</span>
            <button id="btnLogin" class="action-btn" style="background-color: #4285F4; width: auto; padding: 8px 20px; font-size: 14px; white-space: nowrap;">Google ç™»å…¥</button>
        </div>
        
        <div id="userProfile" style="display: none; align-items: center; justify-content: flex-end; gap: 15px; width: 100%; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 10px; margin-right: auto;">
                <img id="userAvatar" src="" style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid #ddd;">
                <span id="userName" style="font-weight: bold; font-size: 15px;"></span>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button id="btnMyCharts" class="map-btn" style="width: auto; background-color: #2196f3;">æˆ‘çš„æ’ç›¤</button>
                <button id="btnLogout" class="map-btn" style="width: auto; background-color: #666;">ç™»å‡º</button>
            </div>
        </div>
    </div>

    <div class="control-wrapper" id="inputWrapper">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('solar')">å…¬æ›†è¼¸å…¥</div>
            <div class="tab" onclick="switchTab('lunar')">è¾²æ›†è¼¸å…¥</div>
            <div class="tab" onclick="switchTab('ganzhi')">å¹²æ”¯è¼¸å…¥</div>
        </div>

        <div class="input-row">
            <span>ç¨±å‘¼ï¼š</span>
            <input type="text" id="nameInput" placeholder="è¼¸å…¥å§“å" style="width: 100px;">
            
            <span>åˆ†é¡ï¼š</span>
            <select id="tagsInput" style="width: 100px;">
                <option value="å®¢æˆ¸">å®¢æˆ¸</option>
                <option value="æœ‹å‹">æœ‹å‹</option>
                <option value="å®¶äºº">å®¶äºº</option>
                <option value="è‡ªå·±">è‡ªå·±</option>
                <option value="åäºº">åäºº</option>
                <option value="ç ”ç©¶æ¡ˆä¾‹">ç ”ç©¶æ¡ˆä¾‹</option>
            </select>

            <select id="gender" style="width: 100px;">
                <option value="1">ç”· (ä¹¾é€ )</option>
                <option value="0">å¥³ (å¤é€ )</option>
            </select>
        </div>

        <div class="input-row" id="panelSolar">
            <span>è¥¿æ›†ï¼š</span>
            <input type="datetime-local" id="birthDate">
        </div>

        <div class="input-row" id="panelLunar" style="display:none;">
            <span>è¾²æ›†ï¼š</span>
            <div style="display:flex; gap:5px; width:100%;">
                <input type="number" id="lunarYear" placeholder="å¹´" style="flex:1">
                <select id="lunarMonth" style="flex:1"></select>
                <select id="lunarDay" style="flex:1"></select>
            </div>
            <div style="display:flex; gap:5px; width:100%; align-items:center;">
                <select id="lunarHour" style="flex:2"></select>
                <label style="flex:1; font-size:12px; color:#666;"><input type="checkbox" id="isLeap"> é–æœˆ</label>
            </div>
        </div>

        <div class="input-row" id="panelGanZhi" style="display:none; flex-direction:column; gap:10px;">
            <div style="font-size:12px; color:#888; margin-bottom:5px;">* ç³»çµ±å°‡æœå°‹1924-2044å¹´é–“ç¬¦åˆçš„æ—¥æœŸ</div>
            <div style="display:flex; gap:5px; align-items:center; width:100%;">
                <span style="width:30px; font-weight:bold; color:#555;">å¹´æŸ±</span>
                <select id="gzYearGan" style="flex:1"></select>
                <select id="gzYearZhi" style="flex:1"></select>
            </div>
            <div style="display:flex; gap:5px; align-items:center; width:100%;">
                <span style="width:30px; font-weight:bold; color:#555;">æœˆæŸ±</span>
                <select id="gzMonthGan" style="flex:1"></select>
                <select id="gzMonthZhi" style="flex:1"></select>
            </div>
            <div style="display:flex; gap:5px; align-items:center; width:100%;">
                <span style="width:30px; font-weight:bold; color:#555;">æ—¥æŸ±</span>
                <select id="gzDayGan" style="flex:1"></select>
                <select id="gzDayZhi" style="flex:1"></select>
            </div>
            <div style="display:flex; gap:5px; align-items:center; width:100%;">
                <span style="width:30px; font-weight:bold; color:#555;">æ™‚æŸ±</span>
                <select id="gzHourGan" style="flex:1"></select>
                <select id="gzHourZhi" style="flex:1"></select>
            </div>
        </div>

        <div class="tst-section">
            <button class="map-btn" id="btnToggleMap" onclick="toggleMap()">ğŸ“ é–‹å•Ÿåœ°åœ–è¨­å®šåœ°é»</button>
            <div style="display:flex; gap:5px; width:100%;">
                <input type="text" id="locationName" placeholder="åœ°é»ï¼ˆå¦‚ï¼šé¦™æ¸¯ï¼‰ï¼ŒæŒ‰æœå°‹å®šä½ç¶“åº¦" style="flex:1;">
                <button class="map-btn" onclick="searchLocation()" style="width:60px;">æœå°‹</button>
            </div>
            
            <div class="tst-bottom-row">
                <span style="font-size:12px; color:#555; white-space:nowrap;">ç¶“åº¦:</span>
                <input type="number" id="longitude" value="120.0" step="0.01" style="width:80px;">
                
                <label style="font-weight:bold; color:var(--active-border); cursor:pointer; font-size:12px; display:flex; align-items:center; gap:4px; margin-left:10px;">
                    <input type="checkbox" id="useTST" style="width:auto; margin:0;"> çœŸå¤ªé™½æ™‚
                </label>

                <label id="lblSaveChart" class="disabled-label" style="font-weight:bold; font-size:12px; display:flex; align-items:center; gap:4px; margin-left:15px; transition: all 0.3s;">
                    <input type="checkbox" id="saveChartCheck" disabled style="width:auto; margin:0;"> ä¿å­˜å‘½ç›¤
                </label>
            </div>
        </div>

        <div id="mapContainer"></div>
        <div class="note">* é è¨­æ™‚å€ç‚º UTC+8ã€‚å¦‚å‹¾é¸çœŸå¤ªé™½æ™‚ï¼Œç³»çµ±å°‡æ ¹æ“šç¶“åº¦åŠå‡æ™‚å·®æ ¡æ­£å‡ºç”Ÿæ™‚é–“ã€‚</div>

        <div style="margin-top:15px; text-align:center;">
    <button class="action-btn" onclick="window.startNewChart()">é–‹å§‹æ–°æ’ç›¤</button>
</div>
        <span id="statusMsg" style="color: #d32f2f; display: none; font-weight: bold;">Library æœªåŠ è¼‰</span>
    </div>

    <div class="toggle-bar" id="toggleBar" onclick="toggleInputs()">
        â–¼ æ”¶èµ·è¼¸å…¥å€
    </div>

    <div id="infoDashboard" class="info-dashboard">
        <div class="info-col left">
            <div class="info-item"><span class="info-label">ç¨±å‘¼:</span><span class="info-val" id="dispName">-</span></div>
            <div class="info-item"><span class="info-label">ç”·/å¥³:</span><span class="info-val" id="dispGender">-</span></div>
            <div class="info-item"><span class="info-label">å‡ºç”Ÿåœ°é»:</span><span class="info-val" id="dispLoc">-</span></div>
        </div>
        <div class="info-col">
            <div class="info-item"><span class="info-label">å…¬æ›†:</span><span class="info-val" id="dispSolar">-</span></div>
            <div class="info-item"><span class="info-label">è¾²æ›†:</span><span class="info-val" id="dispLunar">-</span></div>
            <div class="info-item"><span class="info-label">çœŸå¤ªé™½æ™‚:</span><span class="info-val" id="dispTST">-</span></div>
        </div>
    </div>

    <div class="main-display" id="topDisplay" style="display:none;">
        <div class="group-container">
            <div class="group-label">åŸå±€</div>
            <div class="pillar main" id="baseHour"></div>
            <div class="pillar main" id="baseDay"></div>
            <div class="pillar main" id="baseMonth"></div>
            <div class="pillar main" id="baseYear"></div>
        </div>
        <div class="group-container dynamic-group">
            <div class="pillar main" id="activeDaYun"></div>
            <div class="pillar main" id="activeYear"></div>
            <div class="pillar main" id="activeMonth"></div>
            <div class="pillar main" id="activeDay"></div>
            <div class="pillar main" id="activeHour"></div>
        </div>
    </div>

    <div class="rail-container" id="rails" style="display:none;">
        <div class="rail-row"><div class="rail-title">å¤§é‹</div><div class="rail-items" id="dayunRail"></div></div>
        <div class="rail-row"><div class="rail-title">æµå¹´</div><div class="rail-items" id="yearRail"></div></div>
        <div class="rail-row"><div class="rail-title">æµæœˆ</div><div class="rail-items" id="monthRail"></div></div>
        <div class="rail-row"><div class="rail-title">æµæ—¥</div><div class="rail-items" id="dayRail"></div></div>
        <div class="rail-row"><div class="rail-title">æµæ™‚</div><div class="rail-items" id="hourRail"></div></div>
    </div>

    <div id="chartModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-row">
                    <h3>ğŸ“‚ æˆ‘çš„å‘½ç›¤ç´€éŒ„</h3>
                    <span class="close-modal" onclick="closeChartModal()">Ã—</span>
                </div>
                
                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å§“åæˆ–å¹´ä»½...">
                
                <div class="category-filters">
                    <button class="filter-chip active" onclick="filterCategory('å…¨éƒ¨')">å…¨éƒ¨</button>
                    <button class="filter-chip" onclick="filterCategory('å®¢æˆ¸')">å®¢æˆ¸</button>
                    <button class="filter-chip" onclick="filterCategory('æœ‹å‹')">æœ‹å‹</button>
                    <button class="filter-chip" onclick="filterCategory('å®¶äºº')">å®¶äºº</button>
                    <button class="filter-chip" onclick="filterCategory('è‡ªå·±')">è‡ªå·±</button>
                    <button class="filter-chip" onclick="filterCategory('åäºº')">åäºº</button>
                    <button class="filter-chip" onclick="filterCategory('ç ”ç©¶æ¡ˆä¾‹')">ç ”ç©¶æ¡ˆä¾‹</button>
                </div>
            </div>
            <div id="chartList" class="chart-list">
                <p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <div class="app-footer">
        <p>Â© 2025 é€¸æ™´å‘½ç† All Rights Reserved.</p>
        <a href="https://instagram.com/start_8words" target="_blank">
            <svg class="ig-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            @start_8words
        </a>
    </div>

    <script src="script.js?v=3.0"></script>

    <script type="module">
        import { auth, db, provider, signInWithPopup, signOut, onAuthStateChanged, collection, addDoc, query, where, orderBy, getDocs, deleteDoc, doc, setDoc } from './firebase-config.js';

        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const btnMyCharts = document.getElementById('btnMyCharts');
        
        const saveChartCheck = document.getElementById('saveChartCheck');
        const lblSaveChart = document.getElementById('lblSaveChart');
        
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const loggedOutUI = document.getElementById('loggedOutUI');
        
        const modal = document.getElementById('chartModal');
        const chartList = document.getElementById('chartList');
        const searchInput = document.getElementById('searchInput');

        let currentUser = null; 
        let allCharts = []; 
        let currentCategory = 'å…¨éƒ¨';

        // --- ç™»å…¥ ---
        if (btnLogin) {
            btnLogin.addEventListener('click', () => {
                signInWithPopup(auth, provider).catch((error) => alert(error.message));
            });
        }

        // --- ç™»å‡º ---
        if (btnLogout) {
            btnLogout.addEventListener('click', () => {
                signOut(auth).then(() => { location.reload(); });
            });
        }

        // --- â˜… å…¨å±€è‡ªå‹•å„²å­˜åŠŸèƒ½ (å„ªåŒ–ç‰ˆ) ---
        window.handleAutoSave = async () => {
            // 1. æª¢æŸ¥è³‡æ–™
            if (!window.currentBaziData) {
                console.log("No bazi data to save");
                return;
            }
            // 2. æª¢æŸ¥ç”¨æˆ¶ (ä½¿ç”¨ auth.currentUser æœ€ç©©é™£)
            const user = auth.currentUser;
            if (!user) {
                console.log("User not logged in, skip save");
                return;
            }

            const dataToSave = {
                userId: user.uid,
                userEmail: user.email,
                ...window.currentBaziData,
                timestamp: new Date()
            };

            try {
                // 3. æ–°å¢è³‡æ–™
                await addDoc(collection(db, "charts"), dataToSave);
                
                // 4. æˆåŠŸæç¤º
                setTimeout(() => {
                    alert("âœ… å‘½ç›¤å·²è‡ªå‹•ä¿å­˜ï¼");
                }, 100);

            } catch (e) {
                console.error("Auto save failed:", e);
                alert("è‡ªå‹•ä¿å­˜å¤±æ•—: " + e.message);
            }
        };

        // --- æˆ‘çš„æ’ç›¤ (æ‰“é–‹åˆ—è¡¨) ---
        if (btnMyCharts) {
            btnMyCharts.addEventListener('click', async () => {
                if (!auth.currentUser) return;
                modal.style.display = 'flex'; 
                chartList.innerHTML = '<p style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</p>';
                
                searchInput.value = ''; 
                window.filterCategory('å…¨éƒ¨'); 

                try {
                    const q = query(
                        collection(db, "charts"), 
                        where("userId", "==", auth.currentUser.uid),
                        orderBy("timestamp", "desc")
                    );
                    
                    const querySnapshot = await getDocs(q);
                    allCharts = []; 
                    
                    if (querySnapshot.empty) {
                        chartList.innerHTML = '<p style="text-align:center; padding:20px;">æš«ç„¡å„²å­˜ç´€éŒ„</p>';
                        return;
                    }

                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        data.id = docSnap.id;
                        allCharts.push(data);
                    });

                    applyFilters();

                } catch (e) {
                    console.error(e);
                    chartList.innerHTML = '<p style="text-align:center; color:red;">è®€å–å¤±æ•—</p>';
                }
            });
        }

        function applyFilters() {
            const term = searchInput.value.toLowerCase();
            const filtered = allCharts.filter(c => {
                const nameMatch = (c.name || '').toLowerCase().includes(term);
                const yearMatch = (c.birthDate || '').includes(term);
                const isSearchMatch = nameMatch || yearMatch;
                const isCategoryMatch = (currentCategory === 'å…¨éƒ¨') || (c.tags === currentCategory);
                return isSearchMatch && isCategoryMatch;
            });
            renderChartList(filtered);
        }

        window.filterCategory = function(category) {
            currentCategory = category;
            const chips = document.querySelectorAll('.filter-chip');
            chips.forEach(chip => {
                if (chip.innerText === category) {
                    chip.classList.add('active');
                } else {
                    chip.classList.remove('active');
                }
            });
            applyFilters();
        }

        searchInput.addEventListener('input', () => {
            applyFilters();
        });

        function renderChartList(charts) {
            chartList.innerHTML = '';
            if (charts.length === 0) {
                chartList.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</p>';
                return;
            }

            charts.forEach(data => {
                const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : '';
                const div = document.createElement('div');
                div.className = 'chart-item';
                const tagHtml = data.tags ? `<span style="background:#e3f2fd; color:#1976d2; padding:2px 5px; border-radius:4px; font-size:11px; margin-left:5px;">${data.tags}</span>` : '';
                
                const genderStr = data.gender === 1 ? 'ç”·' : 'å¥³';

                div.innerHTML = `
                    <div class="chart-info">
                        <div class="chart-name">${data.name} ${tagHtml} <span style="font-size:12px; color:#666;">(${genderStr})</span></div>
                        <div class="chart-detail">${data.birthDate}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteChart(event, '${data.id}')">åˆªé™¤</button>
                `;
                
                div.querySelector('.chart-info').addEventListener('click', () => {
                    loadChartData(data);
                    modal.style.display = 'none';
                });

                chartList.appendChild(div);
            });
        }

        function loadChartData(data) {
            document.getElementById('nameInput').value = data.name || '';
            document.getElementById('gender').value = data.gender;
            document.getElementById('locationName').value = data.location || '';
            document.getElementById('useTST').checked = data.useTST || false;
            
            const tagsSelect = document.getElementById('tagsInput');
            if (tagsSelect) tagsSelect.value = data.tags || 'å®¢æˆ¸';

            if (saveChartCheck) saveChartCheck.checked = false;

            window.switchTab('solar'); 
            const isoTime = data.birthDate.replace(' ', 'T').substring(0, 16);
            document.getElementById('birthDate').value = isoTime;

            window.currentDocId = data.id;
            window.initChart();
        }

        window.deleteChart = async (e, docId) => {
            e.stopPropagation();
            if(!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
            try {
                await deleteDoc(doc(db, "charts", docId));
                window.currentDocId = null;
                const idx = allCharts.findIndex(c => c.id === docId);
                if (idx > -1) {
                    allCharts.splice(idx, 1);
                    applyFilters(); 
                }
            } catch (err) {
                alert("åˆªé™¤å¤±æ•—");
            }
        }

        window.closeChartModal = () => {
            document.getElementById('chartModal').style.display = 'none';
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if(loggedOutUI) loggedOutUI.style.display = 'none';
                if(userProfile) {
                    userProfile.style.display = 'flex';
                    if(userName) userName.innerText = user.displayName;
                    if(userAvatar) userAvatar.src = user.photoURL;
                }
                if(saveChartCheck) {
                    saveChartCheck.disabled = false;
                }
                if(lblSaveChart) {
                    lblSaveChart.classList.remove('disabled-label');
                    lblSaveChart.style.color = 'var(--active-border)';
                    lblSaveChart.style.cursor = 'pointer';
                }
            } else {
                currentUser = null;
                if(loggedOutUI) loggedOutUI.style.display = 'flex';
                if(userProfile) userProfile.style.display = 'none';
                if(saveChartCheck) {
                    saveChartCheck.disabled = true;
                    saveChartCheck.checked = false;
                }
                if(lblSaveChart) {
                    lblSaveChart.classList.add('disabled-label');
                }
            }
        });
    </script>
</body>
</html>


