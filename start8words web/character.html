<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ å…«å­—èƒ½é‡åˆ†æå„€ âœ¨</title>
    <!-- å¼•å…¥ Lunar.js (æ’ç›¤åº«) -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.js"></script>
    <!-- å¼•å…¥ Chart.js (é›·é”åœ–ç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥å¯æ„›çš„åœ“é«”å­—å‹ (å¦‚æœæœ‰) -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Zcool+KuaiLe&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #FF6B6B; /* æ´»æ½‘ç´… */
            --secondary-color: #4ECDC4; /* æ¸…æ–°ç¶  */
            --accent-color: #FFE66D; /* äº®é»ƒ */
            --dark-bg: #1A1A2E; /* æ·±ç´«èƒŒæ™¯ */
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #2C3E50;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at center, #2E2157 0%, #050508 100%); /* å¤¢å¹»æ˜Ÿç©ºèƒŒæ™¯ */
            font-family: 'Nunito', 'Microsoft JhengHei', sans-serif;
            color: white;
        }
        
        /* === å·¦ä¸Šè§’æ§åˆ¶é¢æ¿ (å¯æ„›å¡ç‰‡é¢¨) === */
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 280px;
            padding: 20px;
            z-index: 10;
            
            background: var(--card-bg);
            border-radius: 25px; /* å¤§åœ“è§’ */
            border: 4px solid #fff;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), inset 0 0 20px rgba(255,255,255,0.5);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* å½ˆæ€§å‹•ç•« */
            color: var(--text-main);
        }

        h1 { 
            margin: 0 0 15px 0; 
            font-size: 1.3rem; 
            color: #FF6B6B; 
            text-align: center;
            font-weight: 900; 
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #ffe66d;
        }

        .input-group label { 
            display: block; 
            font-size: 0.85rem; 
            color: #666; 
            margin-bottom: 5px; 
            font-weight: 700;
        }
        
        input[type="datetime-local"] {
            width: 100%;
            background: #f0f3f8;
            border: 2px solid #e0e0e0;
            color: #333;
            padding: 10px;
            border-radius: 15px; /* è—¥ä¸¸å½¢ç‹€ */
            font-family: inherit;
            box-sizing: border-box;
            font-size: 0.9rem;
            outline: none;
            transition: 0.3s;
        }
        input[type="datetime-local"]:focus {
            border-color: var(--secondary-color);
            background: #fff;
        }

        /* æ€§åˆ¥é¸æ“‡ - æ°£æ³¡æŒ‰éˆ• */
        .gender-group { display: flex; gap: 10px; margin-bottom: 15px; margin-top: 10px; }
        .gender-option { flex: 1; }
        .gender-radio { display: none; }
        .gender-label {
            display: block; text-align: center; padding: 8px;
            background: #eee; border: 2px solid transparent;
            border-radius: 15px; cursor: pointer; font-size: 0.9rem; color: #888;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: bold;
        }
        .gender-radio:checked + .gender-label {
            background: var(--secondary-color); 
            color: #fff; 
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        #gender-f:checked + .gender-label {
            background: #FF6B6B;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        /* æŒ‰éˆ•æ¨£å¼ - æœå‡æ„Ÿ */
        button.action-btn {
            width: 100%;
            background: linear-gradient(45deg, #4ECDC4, #556270);
            color: #fff;
            font-weight: 900;
            cursor: pointer;
            border: none;
            margin-top: 10px;
            padding: 12px;
            border-radius: 50px; /* å®Œå…¨åœ“è§’ */
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        button.action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4); 
        }
        button.action-btn:active { transform: translateY(1px); }
        
        /* RPG æŒ‰éˆ• - ç‰¹æ®Šæ¨£å¼ */
        button.rpg-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            margin-top: 15px;
            animation: pulse 2s infinite;
        }
        button.rpg-btn:hover {
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.5);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .bazi-text {
            font-size: 0.9rem;
            color: #555;
            margin-top: 15px;
            line-height: 1.6;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 12px;
            border: 1px dashed #ccc;
        }

        .date-confirm { font-size: 0.75rem; color: var(--secondary-color); margin-top: 4px; display: block; font-weight: bold; }

        /* åœ–ä¾‹å€ */
        #legend-container {
            display: none;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px dashed #eee;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; font-weight: bold; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; box-shadow: 0 0 5px currentColor; }
        .bar-container { flex-grow: 1; height: 8px; background: #eee; margin: 0 10px; border-radius: 4px; overflow: hidden; }
        .bar { height: 100%; border-radius: 4px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .count-text { width: 40px; text-align: right; font-family: 'Nunito', monospace; opacity: 0.8; font-size: 0.8rem; }

        .toggle-details-btn {
            background: transparent;
            border: 2px solid #eee;
            color: #888;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.8rem;
            padding: 6px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .toggle-details-btn:hover { background: #eee; color: #555; }

        /* === RPG è§’è‰²å¡ Modal (éŠæˆ²é¢¨) === */
        #rpg-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 20, 30, 0.85); z-index: 100; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }

        .rpg-card {
            width: 750px; max-width: 95%; height: 480px;
            background: #1a1a2e; /* æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
            border-radius: 30px;
            display: flex; overflow: hidden;
            box-shadow: 
                0 0 0 5px #1a1a2e,
                0 0 0 8px #FF6B6B, /* å¤–æ¡† */
                0 20px 50px rgba(0,0,0,0.8);
            position: relative;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0.8) translateY(50px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* å·¦å´ï¼šè§’è‰²åœ–ç‰‡å€åŸŸ */
        .rpg-visual {
            width: 40%; 
            background: radial-gradient(circle at center, #333, #000);
            position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            border-right: 4px solid #1a1a2e;
        }
        .rpg-rarity-badge {
            position: absolute; top: 20px; left: 20px;
            padding: 8px 18px; border-radius: 12px;
            font-weight: 900; font-style: italic; font-size: 1.8rem;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
            z-index: 2;
            transform: rotate(-5deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .rarity-SSR { background: linear-gradient(45deg, #FFD700, #FDB931); color: #fff; border: 3px solid #fff; }
        .rarity-SR { background: linear-gradient(45deg, #D980FA, #9980FA); color: #fff; border: 2px solid #fff; }
        .rarity-R { background: linear-gradient(45deg, #4ECDC4, #556270); color: #fff; border: 2px solid #fff; }

        /* å³å´ï¼šè³‡è¨Šå€åŸŸ */
        .rpg-info {
            width: 60%; padding: 30px;
            display: flex; flex-direction: column;
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: white;
        }

        .close-modal {
            position: absolute; top: 15px; right: 20px; font-size: 2.5rem; cursor: pointer; color: #fff; z-index: 10;
            background: rgba(0,0,0,0.2); width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; line-height: 0; padding-bottom: 5px;
            transition: 0.2s;
        }
        .close-modal:hover { background: #FF6B6B; transform: rotate(90deg); }

        .rpg-header { margin-bottom: 10px; border-bottom: 2px dashed rgba(255,255,255,0.2); padding-bottom: 10px; }
        .rpg-class-type { font-size: 0.9rem; color: #FFE66D; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .rpg-class-name { font-size: 2.2rem; font-weight: 900; margin: 5px 0; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        
        .rpg-desc { 
            font-size: 0.95rem; color: #ddd; line-height: 1.6; 
            background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;
            margin-bottom: 15px; border-left: 4px solid #FFE66D;
        }

        .chart-wrapper { flex-grow: 1; position: relative; width: 100%; max-height: 180px; }
        
        .stats-list {
            display: flex; justify-content: space-between; margin-top: 10px;
            background: rgba(255,255,255,0.1); padding: 12px; border-radius: 15px;
        }
        .stat-item { text-align: center; flex: 1; border-right: 1px solid rgba(255,255,255,0.1); }
        .stat-item:last-child { border-right: none; }
        .stat-item span { display: block; font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .stat-item b { display: block; font-size: 1.2rem; color: #fff; margin-top: 2px; text-shadow: 0 0 10px currentColor; }

        @media (max-width: 700px) {
            .rpg-card { flex-direction: column; height: auto; max-height: 90vh; overflow-y: auto; width: 90%; }
            .rpg-visual { width: 100%; height: 180px; border-right: none; border-bottom: 4px solid #1a1a2e; }
            .rpg-info { width: 100%; padding: 20px; }
            #ui-container { width: auto; left: 15px; right: 15px; }
        }
    </style>
</head>
<body>

    <!-- å·¦ä¸Šè§’ UI -->
    <div id="ui-container">
        <h1>âœ¨ å…«å­—èƒ½é‡åˆ†æå„€ âœ¨</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label>ğŸ‚ ä½ çš„å‡ºç”Ÿæ™‚é–“ (è¥¿æ›†)</label>
                <input type="datetime-local" id="birth-input">
            </div>
            
            <div class="gender-group">
                <div class="gender-option">
                    <input type="radio" name="gender" id="gender-m" value="1" class="gender-radio" checked>
                    <label for="gender-m" class="gender-label">ğŸ‘¦ ç”·ç”Ÿ</label>
                </div>
                <div class="gender-option">
                    <input type="radio" name="gender" id="gender-f" value="0" class="gender-radio">
                    <label for="gender-f" class="gender-label">ğŸ‘§ å¥³ç”Ÿ</label>
                </div>
            </div>

            <button class="action-btn" onclick="calculateBazi()">
                ğŸ”® é–‹å§‹åˆ†æèƒ½é‡
            </button>
        </div>

        <div class="bazi-text" id="bazi-desc">
            è«‹è¼¸å…¥æ—¥æœŸä»¥æŸ¥çœ‹èƒ½é‡
        </div>

        <button class="action-btn rpg-btn" onclick="showRPGCard()">
            âš”ï¸ å¬å–š RPG è§’è‰²å¡
        </button>

        <button class="toggle-details-btn" id="btn-toggle-legend" onclick="toggleLegend()">
            ğŸ“Š é¡¯ç¤ºè©³ç´°æ•¸æ“š â–¼
        </button>
        
        <div id="legend-container"></div>
    </div>

    <!-- RPG è§’è‰²å¡ Modal -->
    <div id="rpg-modal" onclick="closeRPGModal(event)">
        <div class="rpg-card">
            <span class="close-modal" onclick="document.getElementById('rpg-modal').style.display='none'">&times;</span>
            
            <!-- å·¦å´ï¼šè¦–è¦ºåœ– -->
            <div class="rpg-visual">
                <div id="rarity-badge" class="rpg-rarity-badge rarity-SSR">SSR</div>
                <!-- é€™è£¡ä½¿ç”¨é¡è‰²å€å¡Šä»£æ›¿åœ–ç‰‡ï¼Œå¯¦éš›æ‡‰ç”¨å¯æ›¿æ›ç‚º img src -->
                <div id="class-visual-bg" style="width:100%; height:100%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 6rem; text-shadow: 0 10px 20px rgba(0,0,0,0.5);">
                    ğŸ—¡ï¸
                </div>
            </div>

            <!-- å³å´ï¼šè³‡è¨Š -->
            <div class="rpg-info">
                <div class="rpg-header">
                    <div class="rpg-class-type" id="rpg-main-type">MAIN CLASS</div>
                    <div class="rpg-class-name" id="rpg-job-name">è·æ¥­åç¨±</div>
                </div>
                
                <div class="rpg-desc" id="rpg-job-desc">
                    è·æ¥­æè¿°...
                </div>

                <div class="chart-wrapper">
                    <canvas id="statsChart"></canvas>
                </div>

                <div class="stats-list" id="stats-text-row">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- 1. RPG è·æ¥­æ•¸æ“šåº« ---
        // (ä¿æŒæ•¸æ“šä¸è®Šï¼Œåƒ…ç‚ºé¡¯ç¤ºæ•ˆæœï¼Œicon å¯æ›æˆæ›´æœ‰è¶£çš„)
        const RPG_DATA = {
            wood: {
                label: "æœ¨ç³» (Wood)", color: "#2ecc71",
                mainA: { name: "ğŸ¹ éŠä¿ ç³» (Ranger)", icon: "ğŸ¹" },
                mainB: { name: "ğŸŒ¿ å¾·é­¯ä¼Šç³» (Druid)", icon: "ğŸŒ¿" },
                branches: {
                    wood:  [{ n:"ğŸ§ ç²¾éˆéŠä¿ ", d:"ç®­è¡“å‡ºç¥å…¥åŒ–ï¼Œç™¾ç™¼ç™¾ä¸­ï¼Œæ£®æ—çš„å®ˆè­·è€…ã€‚" }, { n:"ğŸŒ² æ£®æ—ä¹‹å­", d:"èƒ½èˆ‡å¤§è‡ªç„¶æºé€šï¼Œå¬å–šæ¨¹äººèˆ‡è—¤è”“çºç¹æ•µäººã€‚" }],
                    metal: [{ n:"ğŸ¯ ç‹™æ“Šæ‰‹", d:"ä½¿ç”¨ç©¿ç”²ç®­ï¼Œå°ˆé–€é‡å°é«˜é˜²ç¦¦ç›®æ¨™ã€‚" }, { n:"ğŸ¥€ èŠæ£˜è¡“å£«", d:"æ“æ§å¸¶åˆºçš„é‡‘å±¬æ¤ç‰©ï¼Œé€ æˆç‰©ç†æµè¡€å‚·å®³ã€‚" }],
                    water: [{ n:"ğŸŒ«ï¸ éœ§å½±çµæ‰‹", d:"åœ¨è¿·éœ§ä¸­æ½›è¡Œï¼Œæ®ºäººæ–¼ç„¡å½¢ã€‚" }, { n:"ğŸŒŠ æ½®æ±ä½¿è€…", d:"èåˆæ°´çš„æ²»ç™’åŠ›ï¼Œå¼·å¤§çš„ç¾¤é«”æ²»ç™‚å¸«ã€‚" }],
                    fire:  [{ n:"ğŸ’¥ çˆ†è£‚ç®­æ‰‹", d:"ç®­çŸ¢é™„å¸¶çˆ†ç‚¸æ•ˆæœï¼Œé€ æˆç¯„åœæ¿ºå°„å‚·å®³ã€‚" }, { n:"â˜€ï¸ çƒˆé™½è–©æ»¿", d:"å€ŸåŠ©å¤ªé™½ä¹‹åŠ›ï¼Œç‚ºéšŠå‹æä¾›å¼·å¤§çš„æ”»æ“ŠBuffã€‚" }],
                    earth: [{ n:"ğŸƒ å¢æ—å®ˆè­·è€…", d:"æ“…é•·ä½ˆç½®èŠæ£˜é™·é˜±èˆ‡åˆ©ç”¨åœ°å½¢å›°ä½æ•µäººã€‚" }, { n:"ğŸ—¿ å±±å¶ºå·¨äºº", d:"è®Šèº«ç‚ºå·¨å¤§çš„å²©çŸ³ç”Ÿç‰©ï¼Œæ‰¿æ“”éšŠä¼å‚·å®³ã€‚" }]
                }
            },
            fire: {
                label: "ç«ç³» (Fire)", color: "#ff3d00",
                mainA: { name: "ğŸ”¥ ç‚é­”å°ç³» (Pyromancer)", icon: "ğŸ”¥" },
                mainB: { name: "ğŸ˜¡ ç‹‚æˆ°å£«ç³» (Berserker)", icon: "ğŸ˜¡" },
                branches: {
                    fire:  [{ n:"â˜„ï¸ æ¯€æ»…ä¹‹ç‹", d:"æ¥µè‡´çš„ç«ç„°çˆ†ç™¼ï¼Œç‡ƒç›¡ä¸€åˆ‡ã€‚" }, { n:"ğŸ‘¹ ä¿®ç¾…", d:"ç‡ƒç‡’ç”Ÿå‘½å€¼æ›å–æ”»æ“ŠåŠ›ï¼Œè¡€é‡è¶Šä½å‚·å®³è¶Šé«˜ã€‚" }],
                    metal: [{ n:"âš¡ é›»æ¼¿è¡“å£«", d:"å°‡ç«ç„°å£“ç¸®æˆé«˜æº«é›»æ¼¿ï¼Œè²«ç©¿åŠ›æ¥µå¼·ã€‚" }, { n:"âš”ï¸ æˆ°ç¥", d:"ç²¾é€šå„ç¨®æ­¦å™¨ï¼Œæˆ°é¬¥æŠ€å·§ç„¡äººèƒ½æ•µã€‚" }],
                    wood:  [{ n:"ğŸ•¯ï¸ é‡ç«ç¥­å¸", d:"åˆ©ç”¨æ¤ç‰©åŠ©ç‡ƒï¼Œç«ç„°æœƒå‚³æŸ“ä¸¦æŒçºŒç‡ƒç‡’ã€‚" }, { n:"ğŸ§› è¡€é­”", d:"æ”»æ“Šé™„å¸¶å¼·å¤§çš„å¸è¡€æ•ˆæœï¼ŒçºŒèˆªåŠ›æ¥µå¼·ã€‚" }],
                    water: [{ n:"ğŸ’¨ è’¸æ±½è¡“å£«", d:"æ°´ç«ç›¸å‰‹ç”¢ç”Ÿé«˜æº«è’¸æ±½ï¼Œé€ æˆç‡™å‚·è¦–ç·šæ¨¡ç³Šã€‚" }, { n:"ğŸ›¡ï¸ ç¶­äº¬æµ·ç›œ", d:"æ“æœ‰æ¥µé«˜çš„ç•°å¸¸ç‹€æ…‹æŠ—æ€§ï¼Œä¸ç•æ‡¼å¯’å†·ã€‚" }],
                    earth: [{ n:"ğŸŒ‹ ç†”å²©é ˜ä¸»", d:"å¬å–šéš•çŸ³èˆ‡å²©æ¼¿æ”¹è®Šåœ°å½¢ï¼Œå°é–æ•µäººã€‚" }, { n:"ğŸ’ª è »ç‹", d:"æ“æœ‰ä¸å±ˆçš„æ„å¿—ï¼Œå…ç–«æ­»äº¡ä¸€æ®µæ™‚é–“ã€‚" }]
                }
            },
            earth: {
                label: "åœŸç³» (Earth)", color: "#ffc107",
                mainA: { name: "ğŸ›¡ï¸ è–é¨å£«ç³» (Paladin)", icon: "ğŸ›¡ï¸" },
                mainB: { name: "âš—ï¸ ç…‰é‡‘è¡“å£«ç³» (Alchemist)", icon: "âš—ï¸" },
                branches: {
                    earth: [{ n:"ğŸ• ä¸å‹•æ˜ç‹", d:"çµ•å°çš„é˜²ç¦¦ï¼Œèƒ½åå½ˆå—åˆ°çš„ç‰©ç†å‚·å®³ã€‚" }, { n:"ğŸ¤– é­”åƒå¤§å¸«", d:"è£½é€ å·¨å¤§çš„å²©çŸ³å‚€å„¡å”åŠ©æˆ°é¬¥ã€‚" }],
                    metal: [{ n:"ğŸ° è–æ®¿é¨å£«", d:"æ“…é•·é˜²å®ˆåæ“Šï¼Œç”¨ç›¾ç‰ŒçŒ›æ“Šæ•µäººé€ æˆæšˆçœ©ã€‚" }, { n:"ğŸ¦¾ é‹¼ä¹‹ç…‰é‡‘å¸«", d:"èƒ½å¤ åˆ†è§£èˆ‡é‡çµ„ç‰©è³ªï¼Œæ”¹è®Šæˆ°å ´åœ°å½¢ã€‚" }],
                    wood:  [{ n:"âœ¨ å…‰ä¹‹å®ˆè¡›", d:"æ“æœ‰å¼·å¤§çš„è‡ªæˆ‘æ¢å¾©èƒ½åŠ›ï¼Œå¹¾ä¹ä¸æ­»çš„å­˜åœ¨ã€‚" }, { n:"ğŸ§ª è—¥åŠ‘å¤§å¸«", d:"æŠ•æ“²å„ç¨®è—¥æ°´ï¼Œèƒ½æ²»ç™‚éšŠå‹ä¹Ÿèƒ½æ¯’æ®ºæ•µäººã€‚" }],
                    water: [{ n:"âš–ï¸ å¯©åˆ¤å®˜", d:"æ“æœ‰æ·¨åŒ–èƒ½åŠ›ï¼Œèƒ½é©…æ•£éšŠå‹çš„è² é¢ç‹€æ…‹ã€‚" }, { n:"ğŸ“– è³¢è€…", d:"æ“æœ‰ç„¡ç›¡çš„çŸ¥è­˜ï¼Œèƒ½çœ‹ç©¿æ•µäººçš„å¼±é»ã€‚" }],
                    fire:  [{ n:"ğŸŒ… é»æ˜ä½¿è€…", d:"æ•£ç™¼ç¥è–å…‰ç’°ï¼Œå°å‘¨åœä¸æ­»ç”Ÿç‰©é€ æˆç¼ç‡’ã€‚" }, { n:"ğŸ’£ ç‚¸å½ˆç‹‚äºº", d:"ç™¡è¿·æ–¼ç«è—¥ç ”ç©¶ï¼Œè£½é€ ä¸ç©©å®šçš„å±éšªçˆ†ç‚¸ç‰©ã€‚" }]
                }
            },
            metal: {
                label: "é‡‘ç³» (Metal)", color: "#e0e0e0",
                mainA: { name: "âš”ï¸ åŠè–ç³» (Blade Master)", icon: "âš”ï¸" },
                mainB: { name: "ğŸ¤– æ©Ÿæ¢°å¸«ç³» (Machinist)", icon: "ğŸ¤–" },
                branches: {
                    metal: [{ n:"ğŸ—¡ï¸ ç„¡æ¥µåŠç¥", d:"äººåŠåˆä¸€ï¼Œè¿½æ±‚æ¥µè‡´çš„ç‰©ç†ç ´å£åŠ›ã€‚" }, { n:"ğŸšœ æ©Ÿç”²æˆ°ç¥", d:"é§•é§›é‡å‹æ©Ÿç”²ï¼Œæ“æœ‰æœ€é«˜çš„ç‰©ç†é˜²ç¦¦èˆ‡ç«åŠ›ã€‚" }],
                    wood:  [{ n:"ğŸƒ ç–¾é¢¨åŠè±ª", d:"åŠå¦‚ç–¾é¢¨ï¼Œæ“æœ‰æ¥µé«˜çš„é–ƒé¿ç‡èˆ‡é€£æ“Šæ•¸ã€‚" }, { n:"ğŸ¦  ç”ŸåŒ–æˆ°å£«", d:"çµåˆæ©Ÿæ¢°èˆ‡ç”Ÿç‰©ç§‘æŠ€ï¼Œæ“…é•·æ¯’ç´ èˆ‡è‡ªæˆ‘ä¿®å¾©ã€‚" }],
                    water: [{ n:"â„ï¸ éœœå¯’åŠå£«", d:"åŠæ°£é™„å¸¶å¯’å†°ï¼Œæ”»æ“Šæ™‚å‡çµå°æ‰‹ã€‚" }, { n:"ğŸ¤¿ æ·±æµ·æ½›èˆªè€…", d:"ä½¿ç”¨é«˜å£“æ°´åˆ€èˆ‡æ¶²æ…‹å†·å»ç³»çµ±ï¼Œæ“…é•·æŒä¹…æˆ°ã€‚" }],
                    fire:  [{ n:"ğŸ”¥ é­”åŠå£«", d:"åŠåˆƒç‡ƒç‡’è‘—çƒˆç«ï¼Œé€ æˆç‰©ç†èˆ‡é­”æ³•æ··åˆå‚·å®³ã€‚" }, { n:"ğŸ§¨ çˆ†ç ´å°ˆå®¶", d:"ç˜‹ç‹‚æŠ•æ“²ç‚¸å½ˆèˆ‡ç‡ƒç‡’å½ˆï¼Œå¤§ç¯„åœç ´å£å°ˆå®¶ã€‚" }],
                    earth: [{ n:"ğŸ›¡ï¸ é‡è£åŠå£«", d:"æ”¾æ£„é€Ÿåº¦æ›å–é˜²ç¦¦ï¼Œæ‰‹æŒå·¨åŠæ©«æƒæˆ°å ´ã€‚" }, { n:"ğŸš§ æ”»åŸå¦å…‹", d:"ç§»å‹•ç·©æ…¢ä½†å°„ç¨‹æ¥µé çš„é‡ç ²æ‰‹ï¼Œé™£åœ°æˆ°ç‹è€…ã€‚" }]
                }
            },
            water: {
                label: "æ°´ç³» (Water)", color: "#0091ea",
                mainA: { name: "ğŸ—¡ï¸ å½±èˆè€…ç³» (Shadow Dancer)", icon: "ğŸ—¡ï¸" },
                mainB: { name: "ğŸ”® å æ˜Ÿå¸«ç³» (Astrologer)", icon: "ğŸ”®" },
                branches: {
                    water: [{ n:"ğŸ‘» å¹»å½±åˆºå®¢", d:"å¦‚å¹»å½±èˆ¬ç„¡æ³•æ‰æ‘¸ï¼Œæ¥µè‡´çš„é–ƒé¿èˆ‡å–®é«”çˆ†ç™¼ã€‚" }, { n:"ğŸ‘‘ å†°é›ªå¥³çš‡", d:"å‡çµè¬ç‰©ï¼Œæ“æœ‰æœ€å¼·çš„ç¾¤é«”æ§åˆ¶èˆ‡æ¸›é€Ÿèƒ½åŠ›ã€‚" }],
                    metal: [{ n:"ğŸ©¸ è™•åˆ‘è€…", d:"å†·é…·ç„¡æƒ…ï¼Œæ”»æ“Šé™„å¸¶æµè¡€èˆ‡é‡å‚·æ•ˆæœã€‚" }, { n:"ğŸª é¡åƒæ³•å¸«", d:"è£½é€ å¹»è±¡èˆ‡åå°„å‚·å®³ï¼Œè®“æ•µäººè‡ªé£Ÿå…¶æœã€‚" }],
                    wood:  [{ n:"â˜ ï¸ åŠ‡æ¯’ä¹‹åˆƒ", d:"æ­¦å™¨å¡—æ»¿è‡´å‘½æ¯’è—¥ï¼Œæ“…é•·æŒçºŒæ¶ˆè€—å°æ‰‹ã€‚" }, { n:"ğŸ‘ï¸ é è¨€å®¶", d:"æ´å¯Ÿæœªä¾†ï¼Œç‚ºéšŠå‹æä¾›å¹¸é‹èˆ‡è¿´é¿Buffã€‚" }],
                    fire:  [{ n:"ğŸ¥· ç´…è“®å¿è€…", d:"çµåˆç«éå¿è¡“çš„åˆºå®¢ï¼Œçˆ†ç™¼åŠ›æ¥µå¼·ã€‚" }, { n:"ğŸŒ  æ˜Ÿç«è¡“å£«", d:"å¬å–šå®‡å®™æ˜Ÿè¾°ä¹‹åŠ›ï¼Œé€ æˆç„¡è¦–æŠ—æ€§çš„å‚·å®³ã€‚" }],
                    earth: [{ n:"ğŸœï¸ æ²™æš´è¡Œè€…", d:"åˆ©ç”¨æ²™å¡µé®è”½è¦–é‡ï¼Œé™ä½æ•µäººå‘½ä¸­ç‡ã€‚" }, { n:"ğŸª é‡åŠ›æ“ç¸±è€…", d:"æ“æ§å¼•åŠ›å ´ï¼Œå¼·è¡Œä½ç§»æˆ–å£“åˆ¶æ•µäººã€‚" }]
                }
            }
        };

        // --- 2. æ’ç›¤é‚è¼¯ ---
        const GAN_WUXING = { 'ç”²':'wood','ä¹™':'wood','ä¸™':'fire','ä¸':'fire','æˆŠ':'earth','å·±':'earth','åºš':'metal','è¾›':'metal','å£¬':'water','ç™¸':'water' };
        
        // å¢åŠ ä¸­æ–‡å°æ‡‰
        const ELEMENT_CN = { 'wood':'æœ¨', 'fire':'ç«', 'earth':'åœŸ', 'metal':'é‡‘', 'water':'æ°´' };

        const ZHI_CANGGAN = {
            'å­':{water:100}, 'ä¸‘':{earth:60,water:25,metal:15}, 'å¯…':{wood:60,fire:30,earth:10},
            'å¯':{wood:100}, 'è¾°':{earth:60,wood:25,water:15}, 'å·³':{fire:60,earth:25,metal:15},
            'åˆ':{fire:70,earth:30}, 'æœª':{earth:60,fire:30,wood:10}, 'ç”³':{metal:60,water:30,earth:10},
            'é…‰':{metal:100}, 'æˆŒ':{earth:60,metal:30,fire:10}, 'äº¥':{water:70,wood:30}
        };

        const baseTotal = 2500;
        let currentRatios = { wood: 0.2, fire: 0.2, earth: 0.2, metal: 0.2, water: 0.2 };
        let currentChart = null;

        const elementsDef = [
            { id: 'wood',  name: 'æœ¨', cssColor: '#00d26a', baseH: 0.38, baseS: 0.85, baseL: 0.40 },
            { id: 'fire',  name: 'ç«', cssColor: '#ff3d00', baseH: 0.02, baseS: 0.95, baseL: 0.45 },
            { id: 'earth', name: 'åœŸ', cssColor: '#ffc107', baseH: 0.11, baseS: 0.90, baseL: 0.45 },
            { id: 'metal', name: 'é‡‘', cssColor: '#e0e0e0', baseH: 0.55, baseS: 0.10, baseL: 0.65 },
            { id: 'water', name: 'æ°´', cssColor: '#0091ea', baseH: 0.60, baseS: 0.90, baseL: 0.50 }
        ];

        function calculateBazi() {
            const input = document.getElementById('birth-input').value;
            if (!input) { alert("è«‹è¼¸å…¥æ—¥æœŸï¼"); return; }
            const date = new Date(input);
            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth() + 1, date.getDate(), date.getHours(), date.getMinutes(), 0);
            const bazi = solar.getLunar().getEightChar();
            
            const pillars = [
                { gan: bazi.getYearGan(), zhi: bazi.getYearZhi(), weight: 1.0 },
                { gan: bazi.getMonthGan(), zhi: bazi.getMonthZhi(), weight: 2.5 },
                { gan: bazi.getDayGan(), zhi: bazi.getDayZhi(), weight: 1.2 },
                { gan: bazi.getTimeGan(), zhi: bazi.getTimeZhi(), weight: 1.0 }
            ];

            const baziStr = pillars.map(p => p.gan + p.zhi).join(' ');
            const dayMaster = pillars[2].gan; 
            const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            
            const genderVal = document.querySelector('input[name="gender"]:checked').value;
            const genderText = genderVal == "1" ? "ç”·ç”Ÿ" : "å¥³ç”Ÿ";

            // ä½¿ç”¨ ELEMENT_CN é€²è¡Œä¸­æ–‡è½‰æ›
            const masterElement = GAN_WUXING[dayMaster];
            const masterElementCN = ELEMENT_CN[masterElement];

            document.getElementById('bazi-desc').innerHTML = `<strong>ğŸ”® å…«å­—ï¼š</strong>${baziStr}<br><strong>ğŸ§’ æ—¥ä¸»ï¼š</strong>${dayMaster} (${masterElementCN}) / ${genderText}<br><span class="date-confirm">ğŸ“… è¥¿æ›†ï¼š${dateStr}</span>`;

            let scores = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            const GAN_BASE = 15; const ZHI_BASE = 30;

            pillars.forEach(p => {
                if (GAN_WUXING[p.gan]) scores[GAN_WUXING[p.gan]] += GAN_BASE * p.weight;
                const hidden = ZHI_CANGGAN[p.zhi];
                if (hidden) {
                    for (const [el, pct] of Object.entries(hidden)) scores[el] += (ZHI_BASE * (pct / 100)) * p.weight;
                }
            });

            let total = Object.values(scores).reduce((a, b) => a + b, 0) || 1;
            currentRatios = {
                wood: scores.wood / total,
                fire: scores.fire / total,
                earth: scores.earth / total,
                metal: scores.metal / total,
                water: scores.water / total
            };
            updateSystem();
        }

        // --- 3. RPG ç³»çµ± (ç¨€æœ‰åº¦ + å±¬æ€§ä¿®æ­£) ---

        function calculateRPG() {
            // 1. è·æ¥­åˆ¤å®š
            const sorted = Object.entries(currentRatios).sort((a,b) => b[1] - a[1]);
            const mainKey = sorted[0][0]; 
            const mainVal = sorted[0][1]; 
            const subKey = sorted[1][0];  
            const subVal = sorted[1][1];

            const typeIndex = mainVal > 0.35 ? 0 : 1; 
            const mainClassData = RPG_DATA[mainKey];
            const classCategory = typeIndex === 0 ? mainClassData.mainA : mainClassData.mainB;

            let finalSubKey = subKey;
            if (mainVal > 0.5 || mainVal > subVal * 2) {
                finalSubKey = mainKey;
            }
            const branchData = mainClassData.branches[finalSubKey][typeIndex];
            
            // 2. ç¨€æœ‰åº¦åˆ¤å®š (Rarity)
            let rarity = 'R';
            let rarityColor = '#3498db';
            let focusScore = mainVal + (subVal * 0.5); // å°ˆæ³¨åº¦

            if (mainVal > 0.45) { // æ¥µåº¦å°ˆç²¾
                rarity = 'SSR'; rarityColor = '#FFD700';
            } else if (mainVal > 0.35 || focusScore > 0.55) { // å¼·å‹¢
                rarity = 'SR'; rarityColor = '#9b59b6';
            }

            // 3. å±¬æ€§è¨ˆç®— (ä¿®æ­£ç‰ˆ: æ›´é›£é”åˆ° 100)
            const r = currentRatios;
            const calcStat = (val) => Math.min(99, Math.round(30 + val * 120)); 

            const rawSTR = r.metal * 1.0 + r.earth * 0.4 + r.fire * 0.2;
            const rawINT = r.water * 1.0 + r.fire * 0.4 + r.wood * 0.2;
            const rawAGI = r.wood * 1.0 + r.water * 0.4 + r.metal * 0.2;
            const rawVIT = r.earth * 1.0 + r.metal * 0.4 + r.wood * 0.2;
            
            const values = Object.values(r);
            const mean = values.reduce((a,b)=>a+b,0) / 5;
            const variance = values.reduce((a,b)=>a + Math.pow(b-mean, 2), 0) / 5;
            const stdDev = Math.sqrt(variance); 
            const rawLUK = 0.2 + (0.4 - stdDev); 

            const s = {
                STR: calcStat(rawSTR),
                INT: calcStat(rawINT),
                AGI: calcStat(rawAGI),
                VIT: calcStat(rawVIT),
                LUK: calcStat(rawLUK)
            };

            return {
                mainName: classCategory.name,
                mainIcon: classCategory.icon,
                jobName: branchData.n,
                jobDesc: branchData.d,
                stats: s,
                rarity: rarity,
                mainColor: RPG_DATA[mainKey].color,
                mainElement: mainKey
            };
        }

        function showRPGCard() {
            const data = calculateRPG();
            const genderVal = document.querySelector('input[name="gender"]:checked').value;
            const genderSuffix = genderVal == "1" ? "male" : "female";

            // è¨­ç½®ç¨€æœ‰åº¦æ¨£å¼
            const badge = document.getElementById('rarity-badge');
            badge.className = `rpg-rarity-badge rarity-${data.rarity}`;
            badge.innerText = data.rarity;

            // è¨­ç½®è¦–è¦ºèƒŒæ™¯è‰²
            const visualBg = document.getElementById('class-visual-bg');
            visualBg.style.background = data.mainColor;
            visualBg.innerHTML = data.mainIcon;

            document.getElementById('rpg-main-type').innerText = data.mainName;
            document.getElementById('rpg-job-name').innerText = data.jobName;
            document.getElementById('rpg-job-desc').innerText = data.jobDesc;
            
            // æ›´æ–°å±¬æ€§æ–‡å­—
            const s = data.stats;
            const statsHtml = `
                <div class="stat-item"><b style="color:#e74c3c">${s.STR}</b><span>STR</span></div>
                <div class="stat-item"><b style="color:#3498db">${s.INT}</b><span>INT</span></div>
                <div class="stat-item"><b style="color:#2ecc71">${s.AGI}</b><span>AGI</span></div>
                <div class="stat-item"><b style="color:#f1c40f">${s.VIT}</b><span>VIT</span></div>
                <div class="stat-item"><b style="color:#9b59b6">${s.LUK}</b><span>LUK</span></div>
            `;
            document.getElementById('stats-text-row').innerHTML = statsHtml;

            // ç¹ªè£½é›·é”åœ–
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['STR', 'INT', 'AGI', 'VIT', 'LUK'],
                    datasets: [{
                        label: 'èƒ½åŠ›å€¼',
                        data: [s.STR, s.INT, s.AGI, s.VIT, s.LUK],
                        backgroundColor: `${data.mainColor}33`, 
                        borderColor: data.mainColor,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#ccc', font: { size: 12, family: 'Nunito' } },
                            ticks: { display: false, max: 100, min: 0 },
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            document.getElementById('rpg-modal').style.display = 'flex';
        }

        function closeRPGModal(e) {
            if (e.target.id === 'rpg-modal' || e.target.className.includes('close-modal')) {
                document.getElementById('rpg-modal').style.display = 'none';
            }
        }

        function toggleLegend() {
            const legend = document.getElementById('legend-container');
            const btn = document.getElementById('btn-toggle-legend');
            if (legend.style.display === 'block') {
                legend.style.display = 'none';
                btn.innerText = 'ğŸ“Š é¡¯ç¤ºè©³ç´°æ•¸æ“š â–¼';
            } else {
                legend.style.display = 'block';
                btn.innerText = 'ğŸ“Š éš±è—è©³ç´°æ•¸æ“š â–²';
            }
        }

        // --- 4. Three.js Visuals ---
        let particleSystem, particleAttributes;
        const scene = new THREE.Scene();
        // éœ§æ°£é¡è‰²è¦é…åˆèƒŒæ™¯æ¼¸è®Šçš„ä¸­é–“è‰²
        scene.fog = new THREE.FogExp2(0x1A1A2E, 0.002);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 1000);
        camera.position.z = 45;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.8;

        function getSoftParticleTexture() {
            const cvs = document.createElement('canvas'); cvs.width=64; cvs.height=64;
            const ctx = cvs.getContext('2d');
            const grd = ctx.createRadialGradient(32,32,0,32,32,32);
            grd.addColorStop(0,'rgba(255,255,255,1)'); grd.addColorStop(0.15,'rgba(255,255,255,0.9)'); 
            grd.addColorStop(0.4,'rgba(255,255,255,0.3)'); grd.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle = grd; ctx.fillRect(0,0,64,64);
            const tex = new THREE.Texture(cvs); tex.needsUpdate = true; return tex;
        }

        function updateSystem() {
            if (particleSystem) scene.remove(particleSystem);
            const counts = {}; let total = 0;
            elementsDef.forEach(el => {
                let c = Math.round(baseTotal * currentRatios[el.id]);
                counts[el.id] = c; total += c;
            });

            const lDiv = document.getElementById('legend-container'); lDiv.innerHTML = '';
            elementsDef.forEach(el => {
                const pct = total>0 ? (counts[el.id]/total*100).toFixed(1) : 0;
                lDiv.innerHTML += `<div class="legend-item"><div class="dot" style="background:${el.cssColor}"></div><div style="width:50px">${el.name}</div><div class="bar-container"><div class="bar" style="width:${pct}%;background:${el.cssColor}"></div></div><div class="count-text">${counts[el.id]}</div></div>`;
            });

            const geo = new THREE.BufferGeometry();
            const pos=[], col=[], siz=[], pha=[], baseSiz=[];
            const tmpCol = new THREE.Color();

            elementsDef.forEach(el => {
                for(let i=0; i<counts[el.id]; i++){
                    const r = 12 + Math.random()*14;
                    const theta = Math.random()*Math.PI*2;
                    const phi = Math.acos(2*Math.random()-1);
                    pos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
                    
                    let h=el.baseH+(Math.random()-0.5)*0.06;
                    let s=Math.max(0.3, Math.min(1.0, el.baseS+(Math.random()-0.5)*0.2));
                    let l=Math.max(0.2, Math.min(0.7, el.baseL+(Math.random()-0.5)*0.2));
                    tmpCol.setHSL(h,s,l);
                    col.push(tmpCol.r, tmpCol.g, tmpCol.b);

                    const bs = 2.5+Math.random()*3.5;
                    siz.push(bs); baseSiz.push(bs); pha.push(Math.random()*Math.PI*2);
                }
            });

            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(col,3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(siz,1));
            geo.setAttribute('phase', new THREE.Float32BufferAttribute(pha,1));
            geo.setAttribute('baseSize', new THREE.Float32BufferAttribute(baseSiz,1));

            const mat = new THREE.PointsMaterial({
                size: 3.0, vertexColors: true, map: getSoftParticleTexture(),
                blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.45, sizeAttenuation: true
            });

            particleSystem = new THREE.Points(geo, mat);
            scene.add(particleSystem);
            particleAttributes = particleSystem.geometry.attributes;
        }

        // Init: Set to NOW
        setTimeout(() => {
            if (typeof Solar !== 'undefined') {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
                document.getElementById('birth-input').value = localISOTime;
                calculateBazi();
            }
        }, 500);

        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            time += 0.02;
            if (particleSystem && particleAttributes) {
                const s = particleAttributes.size.array;
                const bs = particleAttributes.baseSize.array;
                const p = particleAttributes.phase.array;
                for(let i=0; i<s.length; i++) s[i] = Math.max(0.1, bs[i] + Math.sin(time*2.5+p[i])*4.5);
                particleAttributes.size.needsUpdate = true;
                particleSystem.rotation.y += 0.0015;
            }
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
